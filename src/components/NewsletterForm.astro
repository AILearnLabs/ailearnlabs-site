---
const siteKey = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY;
---
<form id="newsletter" class="w-full max-w-xl" method="POST" action="/submit">
  <input type="hidden" name="type" value="newsletter" />
  <input type="hidden" name="source" value="landing" />
  <div class="flex flex-col sm:flex-row gap-3">
    <label class="sr-only" for="email">Email</label>
    <input id="email" name="email" type="email" required placeholder="you@example.com" class="flex-1 rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2" />
    <button type="submit" class="btn btn-primary">Get the free starter guide</button>
  </div>
  <div class="mt-3">
    <div class="cf-turnstile" data-sitekey={siteKey} data-size="compact"></div>
  </div>
  <p class="muted text-sm mt-2">No spam. Unsubscribe anytime.</p>
  <p id="nl-error" class="mt-2 text-red-600 hidden" role="alert"></p>
</form>

<script type="module">
  import { isValidEmail } from "../lib/validate";
  const form = document.getElementById('newsletter');
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formEl = e.currentTarget instanceof HTMLFormElement ? e.currentTarget : null;
    const error = document.getElementById('nl-error');
    if (!formEl || !error) return;
    error.classList.add('hidden');
    const fd = new FormData(formEl);
    const email = String(fd.get('email') || '').trim();
    if (!email || !isValidEmail(email)) {
      error.textContent = 'Please enter a valid email address.';
      error.classList.remove('hidden');
      return;
    }
    try {
      const res = await fetch('/submit', { method: 'POST', body: fd });
      if (res.ok) {
        window.location.href = '/success';
      } else {
        const data = await res.json().catch(() => ({}));
        error.textContent = data?.error || 'Something went wrong. Please try again.';
        error.classList.remove('hidden');
      }
    } catch {
      error.textContent = 'Network error. Please try again.';
      error.classList.remove('hidden');
    }
  });
</script>
